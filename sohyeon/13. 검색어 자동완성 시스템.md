# 13장 검색어 자동완성 시스템
- 검색어 자동완성은 많은 제품에 중요하게 사용되는 기능이다.
- 가장 많이 이용된 검색어 k개를 자동완성하여 출력하는 시스템을 설계해 보도록 하자.

<br/>

## 1️⃣ 문제 이해 및 설계 범위 확정
```
지원자: 사용자가 입력하는 단어는 자동완성될 검색어의 첫 부분이어야 하나요? 아니면 중간 부분이 될 수도 있습니까?
면접관: 첫 부분으로 한정하겠습니다.

지원자: 몇 개의 자동완성 검색어가 표시되어야 합니까?
면접관: 5개입니다.

지원자: 자동완성 검색어 5개를 고르는 기준은 무엇입니까?
면접관: 질이 빈도에 따라 정해지는 검색어 인기 순위를 기준으로 삼겠습니다.

지원자: 맞춤법 검사 기능도 제공해야 합니까?
면접관: 아뇨. 맞춤법 검사나 자동수정은 지원하지 않습니다.

지원자: 질의는 영어입니까?
면접관: 네. 하지만 시간이 허락한다면 다국어 지원을 생각해도 좋습니다.

지원자: 대문자나 특수 문자 처리도 해야 합니까?
면접관: 아뇨. 모든 질의는 영어 소문자로 이루어진다고 가정하겠습니다.

지원자: 얼마나 많은 사용자를 지원해야 합니까?
면접관: 일간 능동 사용자(DAU) 기준으로 천만명입니다.
```

<br/>

### 요구사항
- 빠른 응답 속도 (100밀리초 이내)
- 연관성 (입력 단어와 연관된 것)
- 정렬 (인기도 등의 순위 모델에 의해 정렬)
- 규모 확장성 (많은 트래픽을 감당할 수 있도록 확장 가능해야 함)
- 고가용성 (시스템은 계속 사용 가능해야 함)

<br/>

### 개략적 규모 추정
- 일간 능동 사용자(DAU)는 천만 명으로 가정한다.
- 평균적으로 한 사용자는 매일 10건의 검색을 수행한다고 가정한다.
- 질의할 때마다 평균적으로 20바이트의 데이터를 입력한다고 가정한다.
  - 문자 인코딩 방법: ASCII
  - 질의문은 평균적으로 4개 단어로, 각 단어는 평균적으로 5글자로 구성한다고 가정
  - 질의당 평균 4 * 5 = 20
- 글자를 입력할 때마다 자동완성 BE에 요청 전송, 평균적으로 1회 검색당 20건의 요청 전달
- 대략 초당 24,000건의 질의 발생 (10,000,000 사용자 * 10질의 / 일 * 20자 / 24시간 / 3600초)
- 최대 QPS = QPS * 2 = 대략 48,000
- 질의 가운데 20% 정도는 신규 검색어라고 가정 (대략 0.4GB 정도 매일 신규 데이터 추가)

<br/>

## 2️⃣ 개략적 설계안 제시 및 동의 구하기

### 데이터 수집 서비스
- 사용자가 입력한 질의를 실시간으로 수집하는 시스템
- 빈도 테이블(질의문과 사용빈도를 저장)이 있을 때, 사용자가 검색함에 따라 테이블은 주기적으로 업데이트된다.

<br/>

<img width="550" alt="image" src="https://github.com/SPRING-STUDY-2023/System-Design-Interview/assets/55437339/eb47052a-ec36-474a-9ea4-0202341a2daf" />

<br/>

### 질의 서비스
- 주어진 질의에 5개의 인기 검색어를 정렬해 내놓는 서비스
- 데이터 양이 적을 때는 나쁘지 않지만, 데이터가 많아지면 DB 병목이 될 수 있다.

<br/>

|query|frequency|
|---|---|
|twitter|35|
|twitch|29|
|twillight|25|
|twin peak|21|
|twitch prime|18|
|twitter search|14|
|twillo|10|
|twin peak of|8|

🔼 빈도 테이블
- query: 질의문을 저장하는 필드
- frequency: 질의문이 사용된 빈도를 저장하는 필드
- 빈도 테이블에 기록된 수치를 사용해 상위 5개의 검색어를 반환한다.
  - `tw` 검색: twitter, twitch, twillight, twin peak, twitch prime

<br/>

## 3️⃣ 상세 설계
### 트라이 자료구조
- 문자열들을 간략하게 저장할 수 있는 자료구조
- 가장 인기있는 5개 질의문을 골라내는 방안으로 사용한다.

<br/>

<img width="550" alt="image" src="https://github.com/SPRING-STUDY-2023/System-Design-Interview/assets/55437339/d0c42eb4-d758-4aae-aa6b-dd7da9c87d0e" />

🔼 트라이 자료구조
- 트라이는 트리 형태의 자료구조다.
- 이 트리의 루트 노드는 빈 문자열을 나타낸다.
- 각 노드는 글자 하나를 저장하며, 26개의 자식 노드를 가질 수 있다.
- 각 트리 노드는 하나의 단어, 또는 접두어 문자열을 나타낸다.

<br/>

<img width="550" alt="image" src="https://github.com/SPRING-STUDY-2023/System-Design-Interview/assets/55437339/b8c8353d-d150-4a72-afe3-07710564866c" />

🔼 빈도 정보를 저장한 트라이 구조
- p: 접주어의 길이
- n: 트라이 안에 있는 노드 개수
- c: 주어진 노드의 자식 노드 개수
- 가장 많이 사용된 질의어 k개는 다음과 같이 찾을 수 있다.
  - 해당 접두어를 표현하는 노드를 찾는다. (시간복잡도 O(p))
  - 해당 노드부터 시작하는 하위 트리를 탐색하여 모든 유효 노드를 찾는다. (시간복잡도 O(c))
  - 유효 노드들을 정렬하여 가장 인기 있는 검색어 k개를 찾는다. (시간복잡도 O(clogc))
 
<br/>

<img width="550" alt="image" src="https://github.com/SPRING-STUDY-2023/System-Design-Interview/assets/55437339/68a470d4-3f16-4d6b-b75f-114e286a2be0" />

🔼 k=2이고 사용자가 검색창에 be을 입력했을 때, 알고리즘 동작
1. 접두어 노드 be를 찾는다.
2. 해당 노드부터 시작하는 하위 트리를 탐색하여 모든 유효 노드를 찾는다. (beer, best, bet)
3. 유효 노드를 정렬하여 2개만 골라낸다. (best, bet)

<br/>

- 총 시간 복잡도: O(p) + O(c) + O(clogc)
- 최악의 경우 전체 트라이를 다 검색해야 한다. 최적화 방안은 다음과 같다.
  - 접두어의 최대 길이를 제한
  - 각 노드에 인기 검색어를 캐시
 
<br/>

> ***접두어의 최대 길이 제한***

- 사용자가 검색창에 긴 검색어를 입력하는 일은 거의 없기 때문에, p값은 작은 정숫값으로 가정해도 안전하다.

<br/>

> ***노드에 인기 검색어 캐시***

- 각 노드에 k개 인기 검색어를 저장해두면 전체 트라이를 검색하는 일을 방지할 수 있다.
- 👍 검색어를 질의하는 시간 복잡도를 엄청나게 낮출 수 있다.
- 👎 각 노드에 질의어를 저장할 공간이 많이 필요하게 된다.

<br/>

<img width="550" alt="image" src="https://github.com/SPRING-STUDY-2023/System-Design-Interview/assets/55437339/329a1267-1b00-4c24-8e03-b3221c5100f1" />

<br/>

### 데이터 수집 서비스

<img width="550" alt="image" src="https://github.com/SPRING-STUDY-2023/System-Design-Interview/assets/55437339/e1b7f6d7-8843-423f-ace8-d402f39dc09c" />

🔼 데이터 분석 서비스의 수정된 설계안

<br/>

> ***데이터 분석 서비스 로그***

- 검색창에 입력된 질의에 관한 원본 데이터가 보관된다.
- 데이터는 추가만 되고, 수정은 일어나지 않는다.

<br/>

> ***로그 취합 서버***

- 데이터를 잘 취합하여 시스템이 쉽게 소비할 수 있도록 한다.
- 결과를 빨리 보여주는 것이 중요할 경우, 데이터 취합 주기를 보다 짧게 가져간다.
- 대부분의 경우 일주일에 한 번 정도로 로그를 취합해도 충분하다.

<br/>

> ***취합된 데이터***

|query|time|frequency|
|---|---|---|
|tree|2023-10-01|12000|
|tree|2023-10-08|15000|
|toy|2023-10-01|850|
|toy|2023-10-09|6256|

🔼 매주 취합한 데이터의 사례
- time 필드는 해당 주가 시작한 날짜를 나타낸다.
- frequency 필드는 해당 질의가 해당 주에 사용된 횟수의 합이다.

<br/>

> ***작업 서버***

- 주기적으로 비동기적 작업을 실행하는 서버 집합
- 트라이 자료구조를 만들고 트라이 데이터베이스에 저장하는 역할을 담당한다.

<br/>

> ***트라이 캐시***

- 분산 캐시 시스템으로 트라이 데이터를 메모리에 유지하여 읽기 연산 성능을 높이는 구실을 한다.
- 매주 트라이 데이터베이스의 스냅샷을 떠서 갱신한다.

<br/>

> ***트라이 데이터베이스***

- 지속성 저장소
- 사용할 수 있는 선택지는 2가지 있다.
  - 문서 저장소: 주기적으로 트라이를 직렬화하여 데이터베이스에 저장할 수 있다.
  - 키-값 저장소: 해시 테이블 형태로 변환 가능하다.(키: 접두어, 값: 노드에 보관된 모든 데이터)<br/>
    <img width="300" alt="image" src="https://github.com/SPRING-STUDY-2023/System-Design-Interview/assets/55437339/148e6431-207e-4ebc-83b2-c588277a3d68" />

<br/>

### 질의 서비스

<img width="400" alt="image" src="https://github.com/SPRING-STUDY-2023/System-Design-Interview/assets/55437339/25b7fbcd-1a04-499a-9ca3-a095c3dbd7f0" />

🔼 해당 설계안의 비효율성을 개선한 새 설계안
1. 검색 질의가 로드밸런서로 전송된다.
2. 로드밸런서는 해당 질의를 API 서버로 보낸다.
3. API 서버는 트라이 캐시에서 데이터를 가져와 해당 요청에 대한 자동완성 검색어 제안 응답을 구성한다.
4. 데이터가 트라이 캐시에 없는 경우에는 데이터를 데이터베이스에서 가져와 캐시에 채운다.

<br/>

질의 서비스의 최적화 방안은 다음과 같다.
- AJAX 요청 (웹 새로고침 X)
- 브라우저 캐싱 (구글은 검색어를 1시간동안 캐시해 둠)
- 데이터 샘플링 (N개 요청 가운데 1개만 로깅)

<br/>

### 트라이 연산

> ***트라이 생성***

- 작업 서버가 담당한다.
- 데이터 분석 서비스의 로그나 데이터베이스로부터 취합된 데이터를 이용한다.

<br/>

> ***트라이 갱신***

2가지 방법이 있다.
1. 매주 한 번 갱신하는 방법: 새로운 트라이를 만들어 기존 대체
2. 트라이의 각 노드를 개별적으로 갱신하는 방법: 성능은 좋지 않지만 작은 트라이에서 고려해볼만한 방안

<br/>

> ***검색어 삭제***

- 트라이 캐시 앞에 필터 계층을 두고 부적절한 질의어가 반환되지 않도록 한다.
- 물리적 삭제는 다음번 업데이트 사이클에 비동기적으로 진행한다.

<br/>

<img width="550" alt="image" src="https://github.com/SPRING-STUDY-2023/System-Design-Interview/assets/55437339/122cb106-b1e8-475e-aacf-bb9d72cf39a2" />

<br/>

> ***저장소 규모 확장***

- 트라이의 크기가 한 서버에 넣기엔 너무 큰 경우에도 대응할 수 있도록 규모 확장성 문제를 해결해본다.
- 영어만 지원하면 되기 때문에, 첫 글자를 기준으로 샤딩하는 방법을 생각해볼 수 있다.

<br/>

<img width="550" alt="image" src="https://github.com/SPRING-STUDY-2023/System-Design-Interview/assets/55437339/d43946b2-7a2c-41b3-844b-f6136c07975b" />

🔼 과거 질의 데이터의 패턴을 분석하여 샤딩
- 검색어 대응 샤드 관리자는 어떤 검색어가 어느 저장소 서버에 저장되는지에 대한 정보를 관리한다.

<br/>

## 4️⃣ 마무리
추가 질문

### 다국어 지원이 가능하도록 시스템을 확장하려면 어떻게 해야 할까요?
- 트라이에 유니코드 데이터를 저장한다.

<br/>

### 국가별로 인기 검색어 순위가 다르다면 어떻게 해야 하나요?
- 국가별로 다른 트라이를 사용하도록 한다.
- 트라이를 CDN에 저장하여 응답속도를 높일 수 있다.

<br/>

### 실시간으로 변하는 검색어의 추이를 반영하려면 어떻게 해야 하나요?
- 본 설계안에서는 어렵다.
- 샤딩을 통하여 작업 대상 데이터의 양을 줄인다.
- 순위 모델을 바꿔 최근 검색어에 보다 높은 가중치를 주도록 한다.
- 모든 데이터를 동시에 사용할 수 없을 가능성이 있다는 점을 고려해야 한다.
