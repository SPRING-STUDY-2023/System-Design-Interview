# 14장 유튜브 설계
- 유튜브 시스템을 설계해보자.

<br/>

## 1️⃣ 문제 이해 및 설계 범위 확정
```
지원자: 어떤 기능이 가장 중요한가요?
면접관: 비디오를 올리는 기능과 시청하는 기능입니다.

지원자: 어떤 클라이언트를 지원해야 하나요?
면접관: 모바일 앱, 웹 브라우저, 그리고 스마트 TV입니다.

지원자: 일간 능동 사용자 수는 몇 명입니까?
면접관: 5백만입니다.

지원자: 사용자가 이 제품에 평균적으로 소비하는 시간은 얼마인가요?
면접관: 30분입니다.

지원자: 다국어 지원이 필요한가요?
면접관: 네. 어떤 언어로도 이용 가능해야 합니다.

지원자: 어떤 비디오 해상도를 지원해야할까요?
면접관: 현존하는 비디오 종류와 해상도를 대부분 지원해야 합니다.

지원자: 암호화가 필요할까요?
면접관: 네.

지원자: 비디오 파일 크기에 제한이 있습니까?
면접관: 작은 비디오, 혹은 중간 크기 비디오에 초점을 맞추도록 합시다. 비디오 크기는 최대 1GB로 제한합니다.

지원자: 아마존이나 구글, 마이크로소프트가 제공하는 클라우드 서비스를 활용해도 될까요?
면접관: 좋은 질문입니다. 모든 걸 바닥부터 쌓아올리는 것은 대부분 회사에게는 비현실적인 일이죠. 활용할 수만 있다면 하는 것이 바람질할 것입니다.
```

- 빠른 비디오 업로드
- 원활한 비디오 재생
- 재생 품질 선택 기능
- 낮은 인프라 비용
- 높은 가용성과 규모 확장성, 그리고 안정성
- 지원 클라이언트: 모바일 앱, 웹 브라우저, 그리고 스마트 TV

<br/>

### 개략적 규모 추정
- 일간 능동 사용자(DAU) 수는 5백만
- 한 사용자는 하루에 평균 5개의 비디오를 시청
- 10%의 사용자가 하루에 1비디오 업로드
- 비디오 평균 크기는 300MB
- 비디오 저장을 위해 매일 새로 요구되는 저장 용량 = 5백만 * 10% * 300MB = 150TB
- CDN 비용
  - 클라우드 CDN을 통해 비디오를 서비스할 경우 CDN에서 나가는 데이터의 양에 따라 과금한다.
  - 아마존의 CloudFront를 CDN 솔루션으로 사용할 경우, 100% 트래픽이 미국에서 발생한다고 가정하면 1GB당 $0.02의 요금이 발생한다.
  - 따라서 매일 발생하는 요금은 5백만 * 5비디오 * 0.3GB * $0.02 = $150,000이다.
 
<br/>

## 2️⃣ 개략적 설계안 제시 및 동의 구하기
- CDN과 BLOB 스토리지의 경우에는 기존 클라우드 서비스를 활용할 것이다.

<br/>

<img width="550" alt="image" src="https://github.com/SPRING-STUDY-2023/System-Design-Interview/assets/55437339/68bd310c-42e0-4fcc-aabc-8f52585552aa" />

🔼 3개 컴포넌트로 구성된 개략적 설계

- 단말(client): 컴퓨터, 모바일 폰, 스마트 TV를 통해서 유튜브를 시청할 수 있다.
- CDN: 비디오는 CDN에 저장한다. 재생 버튼을 누르면 CDN으로부터 스트리밍이 이루어진다.
- API 서버: 비디오 스트리밍을 제외한 모든 요청은 API 서버가 처리한다. 피드 추천, 비디오 업로드 URL 생성, 메타데이터 데이터베이스와 캐시 갱신, 사용자 가입 등등이 API 서버가 처리하는 과정이다.

<br/>

### 비디오 업로드 절차

<img width="400" alt="image" src="https://github.com/SPRING-STUDY-2023/System-Design-Interview/assets/55437339/de6cc284-4332-4cc5-8214-1540cc1da0aa" />

🔼 비디오 업로드 절차의 개략적 설계안

- 사용자: 컴퓨터나 모바일 폰, 혹은 스마트 TV를 통해 유튜브를 시청하는 이용자
- 로드밸런서: API 서버 각각으로 고르게 요청을 분산하는 역할을 담당한다.
- API 서버: 비디오 스트리밍을 제외한 다른 모든 요청을 처리한다.
- 메타데이터 데이터베이스: 비디오의 메타데이터를 보관한다. (샤딩/리플리케이션을 적용하여 성능/가용성 요구사항 충족)
- 원본 저장소: 원본 비디오를 보관할 대형 이진 파일 저장소(BLOB) 시스템
- 트랜스코딩 서버(비디오 인코딩): 비디오 포맷(MPEG, HLS 등)을 변환하는 절차 (단말/대역폭 요구사항에 맞는 최적의 비디오 스트림 제공에 필요)
- 트랜스코딩 비디오 저장소: 트랜스코딩이 완료된 비디오를 저장하는 BLOB 저장소
- CDN: 비디오를 캐시하는 역할을 담당한다. 사용자가 재생 버튼을 누르면 비디오 스트리밍은 CDN을 통해 이루어진다.
- 트랜스코딩 완료 큐: 비디오 트랜스코딩 완료 이벤트들을 보관할 메시지 큐다.
- 트랜스코딩 완료 핸들러: 트랜스코딩 완료 큐에서 이벤트 데이터를 꺼내 메타데이터 캐시와 데이터베이스를 갱신할 작업 서버들이다.

<br/>

> ***프로세스a : 비디오 업로드***

<img width="550" alt="image" src="https://github.com/SPRING-STUDY-2023/System-Design-Interview/assets/55437339/f51352d8-9bfa-40d4-af9f-3dcdb2c1deb0" />

1. 비디오를 원본 저장소에 업로드한다.
2. 트랜스코딩 서버는 원본 저장소에서 해당 비디오를 가져와 트랜스코딩을 시작한다.
3. 트랜스코딩이 완료되면 아래 두 절차가 병렬적으로 수행된다.
   - 완료된 비디오를 트랜스코딩 비디오 저장소로 업로드한다.
   - 트랜스코딩 완료 이벤트를 트랜스코딩 완료 큐에 넣는다.
     - 트랜스코딩이 끝난 비디오를 CDN에 올린다.
     - 완료 핸들러가 이벤트 데이터를 큐에서 꺼낸다.
       - 완료 핸들러가 메타데이터 데이터베이스를 갱신한다.
       - 완료 핸들러가 메타데이터 캐시를 갱신한다.
4. API 서버가 단말에게 비디오 업로드가 끝나서 스트리밍 준비가 되었음을 알린다.

<br/>

> ***프로세스b : 메타데이터 갱신***

<img width="550" alt="image" src="https://github.com/SPRING-STUDY-2023/System-Design-Interview/assets/55437339/713309a7-c41f-4cbc-a85b-38ec134e76e8" />

- 원본 저장소에 파일이 업로드되는 동안, 단말은 병렬적으로 비디오 메타데이터 갱신 요청을 API 서버에 보낸다.
- 요청에 포함된 메타데이터는 파일 이름, 크기, 포맷 등의 정보가 들어 있다. API 서버는 이 정보로 메타데이터 캐시와 데이터베이스를 업데이트한다.

<br/>

### 비디오 스트리밍 절차

> ***스트리밍 프로토콜***

: 비디오 스트리밍을 위해 데이터를 전송할 때 쓰이는 표준화된 통신 방법

- MPEG(Moving Picture Experts Group)-DASH(Dynamic Adaptive Streaming over HTTP)
- 애플(Apple) HLS(HTTP Live Streaming)
- 마이크로소프트 스무드(Smooth) 스트리밍
- 어도비 HTTP 동적 스트리밍

<br/>

<img width="550" alt="image" src="https://github.com/SPRING-STUDY-2023/System-Design-Interview/assets/55437339/5a8808f8-80d0-4310-b773-8e7a9cd2cb40" />

🔼 개략적 설계
- 사용자의 단말에 가장 가까운 CDN 에지(edge) 서버가 비디오 전송을 담당할 것이므로, 전송지연은 아주 낮다.

<br/>

## 3️⃣ 상세 설계
### 비디오 트랜스코딩
- 비트레이트가 높은 비디오 스트림을 정상 재생하려면 보다 높은 성능의 컴퓨팅 파워가 필요하고, 인터넷 회선 속도도 빨라야 한다.
- 비트레이트가 중요한 이유
  - 가공되지 않은 원본 비디오는 저장 공간을 많이 차지한다.
  - 상당수의 단말과 브라우저는 특정 종류의 비디오 포맷만 지원한다.
  - 끊김없는 비디오 재생 보장을 위해서, 네트워크 대역폭이 충분하지 않은 사용자에게는 저화질 비디오를, 충분한 사용자에게는 고화질 비디오를 보내야 한다.
  - 모바일 단말의 경우 네트워크 상황이 수시로 달라질 수 있다. (비디오 품질 자동/수동 변경이 가능하도록 해야 함)
- 인코딩 포맷
  - 컨테이너(container): 비디오 파일, 오디오, 메타데이터를 담는 바구니 같은 것
  - 코덱(codec): 비디오 화질은 보존하면서 파일 크기를 줄일 목적으로 고안된 압축 및 압축 해제 알고리즘
 
<br/>

### 유향 비순환 그래프(DAG) 모델
- 각기 다른 유형의 비디오 프로세싱 파이프라인을 지원한다.
- 처리 과정의 병렬성을 높이기 위해 적절한 수준의 추상화를 도입하여 클라이언트 프로그래머로 하여금 실행할 작업(task)을 손수 정의할 수 있도록 해야 한다.

<br/>

<img width="550" alt="image" src="https://github.com/SPRING-STUDY-2023/System-Design-Interview/assets/55437339/a8863842-8eb9-469e-9634-3e04457d6dec" />

🔼 비디오 트랜스코딩을 위해 본 설계안이 채택한 DAG 모델
- 검사: 좋은 품질의 비디오인지, 손상은 없는 지 확인하는 작업
- 비디오 인코딩: 비디오를 다양한 해상도, 코덱, 비트레이트 조합으로 인코딩하는 작업
- 섬네일: 사용자가 업로드한 이미지나 비디오에서 자동 추출된 이미지로 섬네일을 만드는 작업
- 워터마크: 비디오에 대한 식별정보를 이미지 위에 오버레이 형태로 띄워 표시하는 작업

<br/>

### 비디오 트랜스코딩 아키텍처

<img width="550" alt="image" src="https://github.com/SPRING-STUDY-2023/System-Design-Interview/assets/55437339/3f9d1f2b-e60c-4f83-9629-83ad8975c217" />

🔼 본 설계안에서 정의한 클라우드 서비스를 활용한 비디오 트랜스코딩 아키텍처
- 이 아키텍처가 동작한 결과로 인코딩된 비디오가 만들어진다.
- 5개의 주요 컴포넌트로 구성된다. 
  - 전처리기
  - DAG 스케줄러
  - 자원 관리자
  - 작업 실행 서버
  - 임시 저장소
 
<br/>

> ***전처리기***

1. 비디오 분할: 비디오 스트림을 GOP(Group of Pictures) 단위로 쪼갠다.
   - GOP는 특정 순서로 배열된 프레임 그룹이다.
   - 하나의 GOP는 독립적으로 재생 가능하며, 길이는 보통 몇 초 정도다.
   - 어떤 종류의 오래된 단말이나 브라우저는 GOP 단위의 비디오 분할을 지원하지 않는다. (전처리기가 대신 역할)
2. DAG 생성: 클라이언트 프로그래머가 작성한 설정 파일에 따라 DAG를 만들어낸다.
3. 데이터 캐시: 전처리기는 분할된 비디오의 캐시이기도 하다. 안정성을 높이기 위해 전처리기는 GOP와 메타데이터를 임시 저장소에 보관한다. 비디오 인코딩이 실패하면 시스템은 보관된 데이터를 활용해 인코딩을 재개한다.

<br/>

> ***DAG 스케줄러***

- DAG 그래프를 몇 개 단계로 분할한 다음에 그 각각을 자원 관리자의 작업 큐에 집어넣는다.

<br/>

<img width="550" alt="image" src="https://github.com/SPRING-STUDY-2023/System-Design-Interview/assets/55437339/6f3e6309-5a12-4473-8f49-9e308694058d" />

🔼 하나의 DAG 그래프를 2개 작업 단계로 쪼갠 사례
- `1단계`: 비디오, 오디오, 메타데이터를 분리한다.
- `2단계`: 해당 비디오 파일을 인코딩하고 섬네일을 추출하며, 오디오 파일 또한 인코딩한다.

<br/>

> ***자원 관리자***

- 자원 배분을 효과적으로 수행하는 역할을 담당한다.

<br/>

<img width="550" alt="image" src="https://github.com/SPRING-STUDY-2023/System-Design-Interview/assets/55437339/104d13c2-d60d-4904-91b6-6073aa2629a0" />

🔼 3개와 큐와 작업 스케줄러로 구성된다.
- 작업 큐: 실행할 작업이 보관되어 있는 우선순위 큐
- 작업 서버 큐: 작업 서버의 가용 상태 정보가 보관되어 있는 우선순위 큐
- 실행 큐: 현재 실행 중인 작업 및 작업 서버 정보가 보관되어 있는 큐
- 작업 스케줄러: 최적의 작업/서버 조합을 골라, 해당 작업 서버가 작업을 수행하도록 지시하는 역할 담당

<br/>

**작업 관리자**
- 작업 관리자는 작업 큐에서 가장 높은 우선순위의 작업을 꺼낸다.
- 작업 관리자는 해당 작업을 실행하기 적합한 작업 서버를 고른다.
- 작업 스케줄러는 해당 작업 서버에게 작업 실행을 지시한다.
- 작업 스케줄러는 해당 작업이 어떤 서버에게 할당되었는지에 관한 정보를 실행 큐에 넣는다.
- 작업 스케줄러는 작업이 완료되면 해당 작업을 실행 큐에서 제거한다.

<br/>

> ***작업 서버***

- DAG에 정의된 작업을 수행한다.

<br/>

<img width="550" alt="image" src="https://github.com/SPRING-STUDY-2023/System-Design-Interview/assets/55437339/cb961515-9e32-4e5b-82d6-9e328ff14ffa" />

- 작업 종류에 따라 작업 서버도 구분하여 관리한다.

<br/>

> ***임시 저장소***

- 여러 저장소 시스템을 활용할 수 있다.
- 저장할 데이터의 유형, 크기, 이용 빈도, 데이터 유효기간 등에 따라 달라진다.
- Ex1. 메타데이터는 작업 서버가 빈번이 참조하고 크기도 보통 작으므로, 메모리에 캐시해두면 좋다.
- Ex2. 비디오/오디오 데이터는 BLOB 저장소에 두는 것이 바람직하다.
- Ex3. 임시 저장소에 보관한 데이터는 비디오 프로세싱이 완료되면 삭제한다.

<br/>

> ***인코딩된 비디오***

- 인코딩 파이프라인의 최종 결과물

<br/>

### 시스템 최적화
- 속도, 안전성, 그리고 비용 측면에서 시스템을 최적화해보자.

<br/>

> ***속도 최적화: 비디오 병렬 업로드***

